"use strict";var __awaiter=(this&&this.__awaiter)||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}
return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}
function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}
function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}
step((generator=generator.apply(thisArg,_arguments||[])).next());});};Object.defineProperty(exports,"__esModule",{value:true});const localit_1=require("localit");exports.default={config:{autoClearEntries:10,autoClearMaxTime:60*60*60,},store:new localit_1.Localit(),getDomainKeys:function(domain){return Object.keys(localStorage).filter(item=>{return item.startsWith(domain+"_")&&!item.endsWith('_expiration_date');});},getExpirationDate(key){return{key:key,date:new Date(JSON.parse(localStorage.getItem(`${key}_expiration_date`)))};},getDomainExpirationDates:function(domain){let keys=this.getDomainKeys(domain);return keys.map(item=>{return this.getExpirationDate(item);});},getFromStoreOrHandler:function(store,key,handler){return __awaiter(this,void 0,void 0,function*(){let result=this.store.get(key);if(result){return result;}
if(typeof handler==="function"){result=yield handler();}
else{result=yield handler;}
return result;});},remember:function(key,time,handler){return __awaiter(this,void 0,void 0,function*(){let store=this.store;store.setDomain('cache-remember');let result=yield this.getFromStoreOrHandler(store,key,handler);if(time!==0)
store.set(key,result,`${time}s`);else
store.set(key,result);return result;});},autoClear:function(key,handler){return __awaiter(this,void 0,void 0,function*(){let store=this.store;store.setDomain('cache-autoclear');let result=yield this.getFromStoreOrHandler(store,key,handler);store.set(key,result,`${this.config.autoClearMaxTime}s`);let expirations=this.getDomainExpirationDates('cache-autoclear');if(expirations.length>this.config.autoClearEntries){let sorted=expirations.sort((a,b)=>{return a.date.getTime()-b.date.getTime();});localStorage.removeItem(sorted[0].key);localStorage.removeItem(sorted[0].key+"_expiration_date");}
return result;});},autoUpdate:function(key,handler){let store=this.store;let pr;store.setDomain('cache-autoupdate');let result=store.get(key);if(typeof handler==="function"){pr=new Promise((resolve)=>__awaiter(this,void 0,void 0,function*(){let result=yield handler();store.set(key,result);resolve(result);}));}
else{pr=new Promise((resolve)=>__awaiter(this,void 0,void 0,function*(){let result=yield handler;store.set(key,result);resolve(result);}));}
return result!==null&&result!==void 0?result:pr;}};